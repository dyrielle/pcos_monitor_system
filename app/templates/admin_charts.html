        {% extends "base.html" %}
    {% block content %}

    <h2>Interactive Scatter Plots (Population)</h2>
    <p class="text-muted">
    Correlations shown regardless of diagnosis. Hover a point to see <em>profile_id</em> and <em>diagnosis</em>. Lines are OLS trendlines.
    </p>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <hr>

    <div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
        <div class="card-header bg-light">
            <strong>Awareness vs Academic Pressure</strong>
        </div>
        <div class="card-body">
            <div id="sc_awareness_pressure" style="width:100%;height:420px;"></div>
        </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
        <div class="card-header bg-light">
            <strong>Awareness vs PCOS-related Symptoms</strong>
        </div>
        <div class="card-body">
            <div id="sc_awareness_symptoms" style="width:100%;height:420px;"></div>
        </div>
        </div>
    </div>
    </div>

    <div class="row">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
        <div class="card-header bg-light">
            <strong>PCOS-related Symptoms vs Academic Pressure</strong>
        </div>
        <div class="card-body">
            <div id="sc_symptoms_pressure" style="width:100%;height:420px;"></div>
        </div>
        </div>
    </div>
    </div>

    <!-- NEW: Correlation Heatmap Section -->
    <hr class="my-5">

    <h3>Correlation Heatmap</h3>
    <p class="text-muted">
        Pearson correlation between all numeric variables. Values range from -1 (negative correlation) to +1 (positive correlation).
    </p>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <strong>Variable Correlation Matrix</strong>
                </div>
                <div class="card-body">
                    <div id="correlation_heatmap" style="width:100%;height:600px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Diagnosis Group Heatmap Section -->
    <hr class="my-5">

    <h3>Symptom Severity by Diagnosis Group</h3>
    <p class="text-muted">
        Average values of health and academic metrics grouped by clinical diagnosis status. 
        Helps identify which symptoms are most prevalent in each diagnosis group.
    </p>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <strong>Mean Metrics by Diagnosis Group</strong>
                </div>
                <div class="card-body">
                    <div id="diagnosis_heatmap" style="width:100%;height:500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <a href="{{ url_for('admin.admin_home') }}" class="btn btn-secondary">Back to Admin Panel</a>

    <script>
    // ----- Data from Flask -----
    const rows = {{ rows | tojson }};

    // Utility: filter rows with both fields present (not null/undefined)
    function pairData(rows, xKey, yKey) {
        const X = [], Y = [], text = [];
        for (const r of rows) {
        const xv = r[xKey], yv = r[yKey];
        if (xv !== null && xv !== undefined && yv !== null && yv !== undefined) {
            X.push(xv);
            Y.push(yv);
            // Hover text: profile_id + diagnosis
            text.push(`profile_id: ${r.profile_id}<br>diagnosis: ${r.diagnosis}`);
        }
        }
        return { X, Y, text };
    }

    // Compute simple OLS trendline (y = m*x + b)
    function ols(X, Y) {
        const n = X.length;
        if (n < 2) return null;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        for (let i = 0; i < n; i++) {
        const x = X[i], y = Y[i];
        sumX += x; sumY += y; sumXY += x*y; sumXX += x*x;
        }
        const denom = (n * sumXX - sumX * sumX);
        if (denom === 0) return null;
        const m = (n * sumXY - sumX * sumY) / denom;
        const b = (sumY - m * sumX) / n;

        const xMin = Math.min(...X), xMax = Math.max(...X);
        const lineX = [xMin, xMax];
        const lineY = [m * xMin + b, m * xMax + b];
        return { m, b, lineX, lineY };
    }

    // Plot helper (white minimal style)
    function drawScatter(divId, X, Y, text, xLabel, yLabel) {
        if (X.length < 2) {
        document.getElementById(divId).innerHTML =
            '<div class="text-muted">Not enough data yet.</div>';
        return;
        }

        const points = {
        x: X, y: Y, text: text,
        mode: 'markers',
        type: 'scatter',
        hovertemplate: '%{text}<br>' + xLabel + ': %{x:.3f}<br>' + yLabel + ': %{y:.3f}<extra></extra>',
        marker: { size: 8 }
        };

        const model = ols(X, Y);
        const trend = model ? {
        x: model.lineX,
        y: model.lineY,
        mode: 'lines',
        name: 'OLS Trendline',
        line: { width: 2 }
        } : null;

        const data = trend ? [points, trend] : [points];

        const layout = {
        paper_bgcolor: 'white',
        plot_bgcolor: 'white',
        margin: { t: 20, r: 20, b: 50, l: 55 },
        xaxis: { title: xLabel, zeroline: false },
        yaxis: { title: yLabel, zeroline: false },
        showlegend: false
        };

        Plotly.newPlot(divId, data, layout, {displaylogo:false, responsive:true});
    }

    // ---- Build each plot ----
    const ap = pairData(rows, 'awareness', 'academic_pressure');
    drawScatter('sc_awareness_pressure', ap.X, ap.Y, ap.text, 'PCOS Awareness', 'Academic Pressure');

    const as_ = pairData(rows, 'awareness', 'symptoms');
    drawScatter('sc_awareness_symptoms', as_.X, as_.Y, as_.text, 'PCOS Awareness', 'PCOS-related Symptoms');

    const sp = pairData(rows, 'symptoms', 'academic_pressure');
    drawScatter('sc_symptoms_pressure', sp.X, sp.Y, sp.text, 'PCOS-related Symptoms', 'Academic Pressure');

    // ----- CORRELATION HEATMAP -----
    const correlationLabels = {{ correlation_labels | tojson }};
    const correlationValues = {{ correlation_values | tojson }};

    if (correlationLabels && correlationLabels.length > 0 && correlationValues && correlationValues.length > 0) {
        const heatmapData = [{
            z: correlationValues,
            x: correlationLabels,
            y: correlationLabels,
            type: 'heatmap',
            colorscale: [
                [0, '#3D5A80'],      // Dark blue (negative correlation)
                [0.5, '#EE6C4D'],    // White (no correlation)
                [1, '#98C1D9']       // Light blue (positive correlation)
            ],
            zmin: -1,
            zmax: 1,
            colorbar: {
                title: 'Correlation',
                titleside: 'right'
            },
            hovertemplate: '%{y} â†” %{x}<br>Correlation: %{z:.3f}<extra></extra>',
            showscale: true
        }];

        const heatmapLayout = {
            title: '',
            xaxis: {
                title: '',
                tickangle: -45,
                side: 'bottom'
            },
            yaxis: {
                title: '',
                autorange: 'reversed'
            },
            margin: {
                l: 150,
                r: 50,
                t: 50,
                b: 150
            },
            plot_bgcolor: '#ffffff',
            paper_bgcolor: '#ffffff'
        };

        const heatmapConfig = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false
        };

        Plotly.newPlot('correlation_heatmap', heatmapData, heatmapLayout, heatmapConfig);
    } else {
        document.getElementById('correlation_heatmap').innerHTML = 
            '<div class="text-center text-muted p-5">Not enough data to generate correlation heatmap. Need at least 2 variables with 2+ data points.</div>';
    }

    // ----- DIAGNOSIS GROUP HEATMAP -----
    const diagnosisLabels = {{ diagnosis_labels | tojson }};
    const metricLabels = {{ metric_labels | tojson }};
    const diagnosisValues = {{ diagnosis_values | tojson }};

    if (diagnosisLabels && diagnosisLabels.length > 0 && diagnosisValues && diagnosisValues.length > 0) {
        const diagnosisHeatmapData = [{
            z: diagnosisValues,
            x: metricLabels,
            y: diagnosisLabels,
            type: 'heatmap',
            colorscale: [
                [0, '#FFFFFF'],      // White (low values)
                [0.25, '#FFE5B4'],   // Peach
                [0.5, '#FFB347'],    // Orange
                [0.75, '#FF6347'],   // Tomato
                [1, '#DC143C']       // Crimson (high values)
            ],
            colorbar: {
                title: 'Mean Value',
                titleside: 'right'
            },
            hovertemplate: '<b>%{y}</b><br>%{x}: %{z:.2f}<extra></extra>',
            showscale: true
        }];

        const diagnosisLayout = {
            title: '',
            xaxis: {
                title: 'Metrics',
                tickangle: -45,
                side: 'bottom'
            },
            yaxis: {
                title: 'Diagnosis Group',
                autorange: 'reversed'
            },
            margin: {
                l: 150,
                r: 100,
                t: 50,
                b: 180
            },
            plot_bgcolor: '#ffffff',
            paper_bgcolor: '#ffffff',
            height: 400
        };

        const diagnosisConfig = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false
        };

        Plotly.newPlot('diagnosis_heatmap', diagnosisHeatmapData, diagnosisLayout, diagnosisConfig);
    } else {
        document.getElementById('diagnosis_heatmap').innerHTML = 
            '<div class="text-center text-muted p-5">Not enough data to generate diagnosis group heatmap. Need at least one diagnosis group with data.</div>';
    }
    </script>

    {% endblock %}